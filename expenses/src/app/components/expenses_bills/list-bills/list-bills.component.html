<app-expenses-expenses_bills-nav/>
@if(viewList){
<div class="container mt-5">
  <h3 class="mb-4">Listado de gastos</h3>

  <div class="container">
    <!-- Fila para los campos de entrada -->
    <form class="row mb-4" #form="ngForm">
      <div class="form-group col-md-3">
        <label for="period">Período</label>
        <select
          id="period"
          class="form-control"
          name="period"
          [(ngModel)]="selectedPeriod"
        >
          @for(period of periodsList; track $index) {
          <option [ngValue]="period">
            {{ period.month }} - {{ period.year }}
          </option>
          }
        </select>
      </div>

      <div class="form-group col-md-3">
        <label for="provider">Proveedor</label>
        <select
          id="provider"
          class="form-control"
          name="provider"
          [(ngModel)]="selectedProvider"
        >
          @for(provider of providersList; track $index) {
          <option [ngValue]="provider">{{ provider.name }}</option>
          }
        </select>
      </div>

      <div class="form-group col-md-3">
        <label for="category">Categoría</label>
        <select
          id="category"
          class="form-control"
          name="category"
          [(ngModel)]="selectedCategory"
        >
          @for(category of categoryList; track $index) {
          <option [ngValue]="category">{{ category.name }}</option>
          }
        </select>
      </div>
      <div class="row m-3 justify-content-end">
        <div class="form-group col-md-1">
          <button
            type="button"
            class="btn btn-primary btn-block"
            (click)="filterBills()"
          >
            Buscar
          </button>
        </div>
        <div class="form-group col-md-5">
          <button
            type="button"
            class="btn btn-secondary btn-block"
            (click)="unFilterBills()"
          >
            Limpiar filtros
          </button>
        </div>
      </div>
    </form>
  </div>

  <!-- Fila para los botones -->

  <div class="table-responsive text-center">
    <table class="table table-bordered">
      <thead class="thead-light">
        <tr>
          
          <!--                    <th>NRO</th>-->
          <th>TIPO</th>
          <th>PROVEEDOR</th>
          <th>MONTO</th>
          <th>PERIODO</th>
          <th>CATEGORIA</th>
          <th>ACCIONES</th>
        </tr>
      </thead>
      <tbody>
        @for (bill of filteredBills; track $index) {
        <tr>
          
          <!--                    <td>{{bill.expenditure_id}}</td>-->
          <td>{{bill.billType? bill.billType.description:"-"}}</td>
                    <td>{{bill.supplier? bill.supplier.name:'-'}}</td>
                    <td>${{bill.amount}}</td>
                    <td>{{(bill.period?.month && bill.period?.year) ? (bill.period?.month + '/' + bill.period?.year) :
                        '-'}}</td>
                    <td>{{bill.category?.name ?? '-'}}</td> 
          <td>
            <button
              class="btn btn-primary btn-sm mr-2"
              (click)="openUpdateModal(bill)"
            >
              <i class="bi bi-eye" (click)="viewBill(bill)"></i>
            </button>

            <!--<button class="btn btn-danger btn-sm" (click)="openDeleteModal(bill.expenditure_id)">
                            <i class="bi bi-trash"></i>
                        </button> -->
          </td>
        </tr>
        }
      </tbody>
    </table>
  </div>

  <nav aria-label="Page navigation example">
    <ul class="pagination justify-content-center">
      <li class="page-item disabled">
        <a class="page-link" href="#" tabindex="-1">&lt;</a>
      </li>
      <li class="page-item active"><a class="page-link" href="#">1</a></li>
      <li class="page-item"><a class="page-link" href="#">2</a></li>
      <li class="page-item"><a class="page-link" href="#">3</a></li>
      <li class="page-item"><a class="page-link" href="#">4</a></li>
      <li class="page-item">
        <a class="page-link" href="#">&gt;</a>
      </li>
    </ul>
  </nav>
</div>
} @else if (!viewList) {
<div class="container mt-4">
  <h3 class="mb-4">Visualizar gasto</h3>
  <form [formGroup]="billForm" (ngSubmit)="saveBill()" class="container mt-4">
    <div class="row">
      <div class="col-md-6 mb-3">
        <label for="supplier_id" class="form-label">Proveedor</label>
        <select
          id="supplier_id"
          formControlName="supplier_id"
          class="form-select"
          [ngClass]="{
            'is-invalid':
              billForm.get('supplier_id')?.invalid &&
              (billForm.get('supplier_id')?.dirty ||
                billForm.get('supplier_id')?.touched)
          }"
        >
          <option value="">Seleccione un proveedor</option>
          @for (provider of providersList ; track provider.id) { @if
          (provider.type == "SUPPLIER"){
          <option [value]="provider.id">{{ provider.name }}</option>
          } }
        </select>
        <div class="invalid-feedback">Por favor, seleccione un proveedor.</div>
      </div>

      <div class="col-md-6 mb-3">
        <label for="category_id" class="form-label">Categoria</label>
        <div class="input-group">
          <select
            id="category_id"
            formControlName="category_id"
            class="form-select"
            [ngClass]="{
              'is-invalid':
                billForm.get('category_id')?.invalid &&
                (billForm.get('category_id')?.dirty ||
                  billForm.get('category_id')?.touched)
            }"
          >
            <option value="">Seleccione una categoría</option>
            @for (category of categoryList; track category.category_id) {
            <option [value]="category.category_id">{{ category.name }}</option>
            }
          </select>
          <button
            class="btn btn-outline-secondary"
            type="button"
            [disabled]="!enableUpdate"
            (click)="openNewCategoryModal()"
          >
            +
          </button>
          <div class="invalid-feedback">
            Por favor, seleccione una categoría.
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-md-6 mb-3">
        <label for="period_id" class="form-label">Periodo</label>
        <select
          id="period_id"
          formControlName="period_id"
          class="form-select"
          [ngClass]="{
            'is-invalid':
              billForm.get('period_id')?.invalid &&
              (billForm.get('period_id')?.dirty ||
                billForm.get('period_id')?.touched)
          }"
        >
          <option value="">Seleccione un periodo</option>
          @for (period of periodsList; track period.id) {
          <option [value]="period.id">
            {{ period.month + "/" + period.year }}
          </option>
          }
        </select>
        <div class="invalid-feedback">Por favor, seleccione un periodo.</div>
      </div>

      <div class="col-md-6 mb-3">
        <label for="type_id" class="form-label">Tipo</label>
        <select
          id="type_id"
          formControlName="type_id"
          class="form-select"
          [ngClass]="{
            'is-invalid':
              billForm.get('type_id')?.invalid &&
              (billForm.get('type_id')?.dirty ||
                billForm.get('type_id')?.touched)
          }"
        >
          <option value="">Seleccione un tipo</option>
          @for (type of typesList; track type.bill_type_id) {
          <option [value]="type.bill_type_id">{{ type.name }}</option>
          }
        </select>
        <div class="invalid-feedback">Por favor, seleccione un tipo.</div>
      </div>
    </div>

    <div class="mb-3">
      <label for="description" class="form-label">Descripción</label>
      <textarea
        id="description"
        formControlName="description"
        class="form-control"
        rows="3"
        [ngClass]="{
          'is-invalid':
            billForm.get('description')?.invalid &&
            (billForm.get('description')?.dirty ||
              billForm.get('description')?.touched)
        }"
      ></textarea>
      <div class="invalid-feedback">Por favor, ingrese una descripción.</div>
    </div>

    <div class="row">
      <div class="col-md-4 mb-3">
        <label for="amount" class="form-label">Monto</label>
        <input
          type="number"
          id="amount"
          formControlName="amount"
          class="form-control"
          [ngClass]="{
            'is-invalid':
              billForm.get('amount')?.invalid &&
              (billForm.get('amount')?.dirty || billForm.get('amount')?.touched)
          }"
        />
        <div class="invalid-feedback">Por favor, ingrese un monto válido.</div>
      </div>

      <div class="col-md-4 mb-3">
        <label for="date" class="form-label">Fecha</label>
        <input
          type="date"
          id="date"
          formControlName="date"
          class="form-control"
          [ngClass]="{
            'is-invalid':
              billForm.get('date')?.invalid &&
              (billForm.get('date')?.dirty || billForm.get('date')?.touched)
          }"
        />
        <div class="invalid-feedback">
          Por favor, seleccione una fecha válida.
        </div>
      </div>

      <div class="col-md-4 mb-3">
        <label for="status" class="form-label">Estado</label>
        <select
          id="status"
          formControlName="status"
          class="form-select"
          [ngClass]="{
            'is-invalid':
              billForm.get('status')?.invalid &&
              (billForm.get('status')?.dirty || billForm.get('status')?.touched)
          }"
        >
          <option value="ACTIVE">Activo</option>
          <option value="CANCELLED">Cancelado</option>
        </select>
        <div class="invalid-feedback">Por favor, seleccione un estado.</div>
      </div>
    </div>

    <div class="d-flex justify-content-end">
      <button
        type="button"
        (click)="enableUpdate()"
        [disabled]="enabelingUpdate"
        class="btn btn-secondary"
      >
        Modificar
      </button>
      <button type="button" (click)="resetForm()" class="btn btn-danger me-2">
        Cancelar
      </button>
      <button
        type="submit"
        class="btn btn-primary"
        [disabled]="billForm.invalid"
      >
        Enviar
      </button>
    </div>
  </form>
</div>

<ng-template #newCategoryModal let-modal>
  <div class="modal-header">
    <h4 class="modal-title">Nueva Categoría</h4>
    <button
      type="button"
      class="btn-close"
      aria-label="Close"
      (click)="modal.dismiss()"
    ></button>
  </div>
  <div class="modal-body">
    <form [formGroup]="newCategoryForm">
      <div class="mb-3">
        <label for="newCategoryName" class="form-label"
          >Nombre de la categoría</label
        >
        <input
          type="text"
          class="form-control"
          id="newCategoryName"
          formControlName="name"
          [ngClass]="{
            'is-invalid':
              newCategoryForm.get('name')?.invalid &&
              (newCategoryForm.get('name')?.dirty ||
                newCategoryForm.get('name')?.touched)
          }"
        />
        <div class="invalid-feedback">
          Por favor, ingrese un nombre para la categoría.
        </div>
      </div>
      <div class="mb-3">
        <label for="newCategoryDescription" class="form-label"
          >Descripcion</label
        >
        <input
          type="text"
          class="form-control"
          id="newCategoryDescription"
          formControlName="description"
          [ngClass]="{
            'is-invalid':
              newCategoryForm.get('description')?.invalid &&
              (newCategoryForm.get('description')?.dirty ||
                newCategoryForm.get('description')?.touched)
          }"
        />
        <div class="invalid-feedback">
          Por favor, ingrese una descripción para la categoría.
        </div>
      </div>
    </form>
  </div>
  <div class="modal-footer">
    <button
      type="button"
      class="btn btn-success"
      (click)="saveNewCategory()"
      [disabled]="newCategoryForm.invalid"
    >
      Confirmar
    </button>
    <button type="button" class="btn btn-danger" (click)="modal.dismiss()">
      Cancelar
    </button>
  </div>
</ng-template>

}
